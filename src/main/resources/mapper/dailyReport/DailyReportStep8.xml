<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dispatch.dump.commonModule.db.mapper.DailyReportStep8Mapper">

    <sql id="res_table">
        WITH r1 AS
                 (SELECT *
                  FROM tsheet
                  WHERE sheetSS2 = ${sheetSS2}
                    AND date BETWEEN ${startDate} AND ${endDate}),
             r2 AS
                 (SELECT *
                  FROM tsheet_sub
                  where sheetsubSS2 = ${sheetsubSS2}),
             r3 AS (SELECT * FROM r1
                             inner join r2 ON r1.sheetid = r2.sheetid2)
    </sql>


    <select id="selectReceiptsByOption" parameterType="DailyReportStep8OptionForm" resultType="DailyReportStep8">
        <include refid="res_table">
            <property name="sheetSS2" value="#{sheetSS2}"/>
            <property name="sheetsubSS2" value="#{sheetsubSS2}"/>
            <property name="startDate" value="#{startDate}"/>
            <property name="endDate" value="#{endDate}"/>
        </include>

        select
        sheetsubID,
        DATE_FORMAT(date,'%m.%d') as 'date',
        fromsite,
        tosite,
        CarNo,
        item,
        Qty,
        Qtyup,
        CurrStatus

        from r3
        <where>
            <if test="CarNo != ''">
                AND CarNo = #{CarNo}
            </if>
            <if test="fromsite != ''">
                AND fromsite = #{fromsite}
            </if>
            <if test="tosite != ''">
                AND tosite = #{tosite}
            </if>
            <if test="item != ''">
                AND item = #{item}
            </if>
        </where>
        <choose>
            <when test="sortingCriteria.equals('date')">
                ORDER BY date DESC, fromsite ASC, tosite ASC
            </when>
            <when test="sortingCriteria.equals('carNo')">
                ORDER BY carNo ASC, date ASC, fromsite ASC, tosite ASC
            </when>
            <when test="sortingCriteria.equals('item')">
                ORDER BY item ASC, date ASC, fromsite ASC, tosite ASC
            </when>
        </choose>
    </select>

    <select id="getSelectBoxData" resultType="DailyReportStep8">
        SELECT distinct t.sheetID,
                        t.CarNo,
                        s.fromsite,
                        s.tosite,
                        s.item
        FROM tsheet t
                 JOIN tSheet_sub s
                      ON t.sheetID = s.sheetID2
        WHERE t.sheetSS2 = #{sheetSS2}
          AND s.sheetsubSS2 = #{sheetsubSS2}
    </select>

    <!--기존꺼-->
    <!--    <sql id="res_table">-->
    <!--        WITH r1 AS-->
    <!--                 (-->
    <!--                     SELECT *-->
    <!--                     FROM tsheet-->
    <!--                     WHERE carsubmittel = ${userId}-->
    <!--                       AND date BETWEEN ${startDate} AND ${endDate}-->
    <!--                 ),-->
    <!--             r2 AS-->
    <!--                 (-->
    <!--                     SELECT *-->
    <!--                     FROM tsheet_sub-->
    <!--                 ),r3 AS(-->
    <!--            SELECT *-->
    <!--            FROM r1-->
    <!--                     INNER JOIN r2-->
    <!--                                ON r1.sheetid = r2.sheetid2-->
    <!--        )-->
    <!--    </sql>-->

    <!--    <select id="selectReceiptsByOption" parameterType="DailyReportStep8OptionForm" resultType="DailyReportStep8">-->
    <!--        <include refid="res_table">-->
    <!--            <property name="userId" value="#{carSubmitTel}"/>-->
    <!--            <property name="startDate" value="#{startDate}"/>-->
    <!--            <property name="endDate" value="#{endDate}"/>-->
    <!--        </include>-->


    <!--        select-->
    <!--        sheetsubID,-->
    <!--        DATE_FORMAT(date,'%m.%d') as 'date',-->
    <!--        fromsite,-->
    <!--        tosite,-->
    <!--        CarNo,-->
    <!--        item,-->
    <!--        Qty,-->
    <!--        Qtyup-->
    <!--        from r3-->
    <!--        <where>-->
    <!--            <if test="CarNo != ''">-->
    <!--                AND CarNo = #{CarNo}-->
    <!--            </if>-->
    <!--            <if test="fromsite != ''">-->
    <!--                AND fromsite = #{fromsite}-->
    <!--            </if>-->
    <!--            <if test="tosite != ''">-->
    <!--                AND tosite = #{tosite}-->
    <!--            </if>-->
    <!--            <if test="item != ''">-->
    <!--                AND item = #{item}-->
    <!--            </if>-->
    <!--        </where>-->
    <!--        <choose>-->
    <!--            <when test="sortingCriteria.equals('date')">-->
    <!--                ORDER BY date DESC, fromsite ASC, tosite ASC-->
    <!--            </when>-->
    <!--            <when test="sortingCriteria.equals('carNo')">-->
    <!--                ORDER BY carNo ASC, date ASC, fromsite ASC, tosite ASC-->
    <!--            </when>-->
    <!--            <when test="sortingCriteria.equals('item')">-->
    <!--                ORDER BY item ASC, date ASC, fromsite ASC, tosite ASC-->
    <!--            </when>-->
    <!--        </choose>-->
    <!--    </select>-->


    <!--    <select id="getSelectBoxData" resultType="DailyReportStep8">-->
    <!--        SELECT distinct t.sheetID,-->
    <!--                        t.CarNo,-->
    <!--                        s.fromsite,-->
    <!--                        s.tosite,-->
    <!--                        s.item-->
    <!--        FROM tsheet t-->
    <!--                 JOIN tSheet_sub s-->
    <!--                      ON t.sheetID = s.sheetID2-->
    <!--        WHERE t.carSubmitTel = #{carSubmitTel}-->
    <!--        order by date desc;-->

    <!--    </select>-->
</mapper>