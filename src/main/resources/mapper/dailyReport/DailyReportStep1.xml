<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dispatch.dump.commonModule.db.mapper.DailyReportStep1Mapper">
    <sql id="res_table">
        WITH r1 AS
            (
                SELECT *
                FROM tsheet
                WHERE sheetSS = #{uuserID}
                  AND date BETWEEN ${startDate} AND ${endDate}
            ),
            r2 AS
           (
        SELECT *
        FROM tsheet_sub
            ),r3 AS(
        SELECT *
        FROM r1
            INNER JOIN r2
        ON r1.sheetid = r2.sheetid2
            )
    </sql>

    <select id="selectCalTotal" parameterType="DailyReportStep1Option" resultType="DailyReportStep1Total">
        <include refid="res_table">
            <property name="userId" value="#{userId}"/>
            <property name="startDate" value="#{option.startDate}"/>
            <property name="endDate" value="#{option.endDate}"/>
        </include>

        select IF(sum(Qty * Qtyup) IS NULL , 0 , sum(Qty * Qtyup)) as 'totalTransportationCost',
        SUM(Qty) as 'totalQty'
        from tSheet_sub
        where sheetID2 in (select sheetid2 from r3)
    </select>

    <select id="selectDispatchSubmitList" resultType="DailyReportStep1Sub">
        <include refid="res_table">
            <property name="userId" value="#{userId}"/>
            <property name="startDate" value="#{today}"/>
            <property name="endDate" value="#{today}"/>
        </include>

        select * from r3
    </select>

    <select id="selectDispatchTdriveList" resultType="DailyReportStep1Tdrive">
        SELECT driveID,
               DATE_FORMAT(drvdate, '%m.%d') AS 'drvdate',
                drvclub,
               chk2,
               lastkm,
               useamt,
               useOil,
               drvrem,
               rependchk,
               IF(rependdate IS NULL, '1999-01-01',rependdate) AS 'rependdate',
                repaddkm
        FROM   tDrive
        where driveSS = #{uuserID}

       /* WHERE  carno = #{userID}
          AND drvdate LIKE CONCAT(#{date}, '%')
        ORDER BY drvclub ASC*/
    </select>








    <!--
    <select id="findDailyReportMainByCarSubmitTel" resultType="DailyReportStep1Main">
        select sheetID, DATE_FORMAT(date, '%y-%m-%d') as date,
        carSubmit,
        salesman,
        sheetSS,
        CarNo
        from tSheet

        where sheetSS = #{uuserID}
    </select>

    <select id="findJoinTdrive" resultType="DailyReportStep1Tdrive">
        select repaddkm, IF(rependdate IS NULL, '1999-01-01',rependdate) AS 'rependdate',
               rependchk,
               drvClub,
               driveSS

        from tDrive
        where driveSS = #{uuserID}

    </select>

    <select id="findDailyReportMainBySheetID2"  resultType="DailyReportStep1Sub">
        select fromsite, tosite, item, Qty,Qtyup,sheetsubSS
        from tSheet_sub where sheetID2=#{sheetID2}
    </select>

    <sql id="res_table">
        with r1 as (select sheetID
                    from tSheet
                    where sheetSS = #{uuserID}),
             r2 as (select sheetID2
                    from tSheet_sub)
    </sql>

    <select id="findJoinDailyReport" resultType="DailyReportStep1Sub">
        <include refid="res_table">
            <property name="userId" value="#{userId}" />
        </include>

        select tSheet_sub.*, tSheet.carSubmit, tSheet.date
        from tSheet_sub
        inner join tSheet on tSheet_sub.sheetID2 = tSheet.sheetID
        where tSheet_sub.sheetID2 in (
        select sheetID2
        from r1 inner join r2
        on r1.sheetID = r2.sheetID2
        )
    </select>

    <select id="findJoinDailyReportForTotalTransportationCost"  resultType="int">
        <include refid="res_table">
            <property name="userId" value="#{userId}"/>
        </include>
        select IF(sum(Qty * Qtyup) IS NULL , 0 , sum(Qty * Qtyup))
        from tSheet_sub
        where sheetID2 in ( select sheetID2 from r1 inner join r2
        on r1.sheetID = r2.sheetID2
        )  AND tSheet_sub.sheetID2 in (
        select sheetID2
        from tSheet
        where date BETWEEN #{startDate} AND #{endDate}
        )

    </select>
-->





</mapper>